<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link type="text/css" id="dark-mode" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css"
        integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
        integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous">
    </script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous">
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/js/bootstrap.min.js"
        integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous">
    </script>
    <script src="https://kit.fontawesome.com/6594176c2b.js" crossorigin="anonymous"></script>
    <title>Mimic revanced - Host</title>
    <link rel="stylesheet" href="./style.css?v=0.36">
</head>

<body>
    <header>
        <div class="top-container unselectable">
            <p class="share-link-prompt-text">Share this link to invite others. (click to copy)</p>
            <div id="receiver-id" onclick="copyShareLink()" title="Copy this link and send it to your friends.">
                f1718af9-f9c5-4df6-a9da-db0954ea2368</div>
            <br>
            <div id="status" class="status">Connected</div>
        </div>
    </header>

    <div class="Main">
        <div class="Main-top-container">
            <h2 class="game-title">Mimic Revanced</h2>
        </div>
        <div class="Main-mid-container">
            <h3>Players:</h3>
            <br>
            <div id="player-list">
                <div class="player-container">
                    <p class="player-name-text">Host</p>
                    <div class="changeName-button-container">
                        <i class="fa-solid fa-pen changeName-button"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="Main-bottom-container">
            <button onclick="activateGame(Object.keys(players).length)">Start Game</button>
        </div>
    </div>

    <footer>
        <div class="footer-container">
            <div class="chat-table">
                <i id="clearMsgsButton" class="fa-solid fa-eraser"></i>
                <div class="message" id="message"></div>
                <div class="send-message-container">
                    <input type="text" id="sendMessageBox" placeholder="Enter a message...">
                    <button type="button" id="sendButton">Send</button>
                </div>
            </div>
        </div>
    </footer>

    <script src="./peerjsmin.js"></script>
    <script type="text/javascript">
        var clientPlayerName = "Host";
        var players = {
            "host": {
                "playerName": clientPlayerName,
                "inPlay": true,
                "role": "NA"
            }
        };

        (function () {

            var lastPeerId = null;
            var peer = null; // Own peer object
            var peerId = null;
            var conn = [];
            var recvId = document.getElementById("receiver-id");
            var status = document.getElementById("status");
            var message = document.getElementById("message");
            var sendMessageBox = document.getElementById("sendMessageBox");
            var sendButton = document.getElementById("sendButton");
            var clearMsgsButton = document.getElementById("clearMsgsButton");
            var playerListElement = document.getElementById("player-list");

            /**
             * Create the Peer object for our end of the connection.
             *
             * Sets up callbacks that handle any events related to our
             * peer object.
             */
            function initialize() {
                // Create own peer object with connection to shared PeerJS server
                peer = new Peer(null, {
                    debug: 2
                });

                peer.on('open', function (id) {
                    // Workaround for peer.reconnect deleting previous id
                    if (peer.id === null) {
                        console.log('Received null id from peer open');
                        peer.id = lastPeerId;
                    } else {
                        lastPeerId = peer.id;
                    }

                    console.log("TEST: " + peer.clientPlayerName)
                    console.log('ID: ' + peer.id);
                    recvId.innerHTML = "<span id=\"share-link\">https://" + window.location
                        .hostname + "/Mimic/send.html?hostid=" + peer.id + "</span>";
                    status.innerHTML = "Awaiting connection...";
                });
                peer.on('connection', function (c) {
                    conn.push(c);
                    console.log("TEST: " + conn);
                    cPlayerID = c.peer
                    players[cPlayerID] = {
                        playerName: "unknown"
                    };
                    currentConn = c
                    console.log("Connected to: " + c.peer);
                    status.innerHTML = "Connected";
                    ready();
                    setTimeout(function () {
                        updatePlayerList();
                    }, 500)
                });
                peer.on('disconnected', function () {
                    status.innerHTML = "Connection lost. Please reconnect";
                    console.log('Connection lost. Please reconnect');

                    // Workaround for peer.reconnect deleting previous id
                    peer.id = lastPeerId;
                    peer._lastServerId = lastPeerId;
                    peer.reconnect();
                });
                peer.on('close', function () {
                    // conn = [];
                    status.innerHTML = "Connection destroyed. Please refresh";
                    console.log('Connection destroyed');
                });
                peer.on('error', function (err) {
                    console.log(err);
                    alert('' + err);
                });
            };

            /**
             * Triggered once a connection has been achieved.
             * Defines callbacks to handle incoming data and connection events.
             */
            function ready() {
                currentConn.on('data', function (data) {
                    console.log("Data recieved");
                    var playerVote = "<span class=\"cueMsg\">" + data[0] + ": </span>";
                    switch (data[0]) {
                        case 'setPlayerData':
                            setPlayerData(data[1]["playerID"], data[1]["playerName"], data[1]["inPlay"]);
                            updatePlayerList();
                        case 'setPlayerName':
                            changePlayerName(data[1]["playerID"], data[1]["playerName"]);
                            console.log(data[1]["playerID"] + " changed to " + data[1]["playerName"]);
                            updatePlayerList();
                            break;
                        case 'F':
                            fade();
                            addMessage(playerVote + data[1]);
                            break;
                        default:
                            for (let step = 0; step < conn.length; step++) {
                                console.log(conn.length);
                                console.log(conn);
                                console.log(players);
                                conn[step].send(["chatMessage", {
                                    "playerName": data[1]["playerName"],
                                    "msg": data[1]["msg"]
                                }]);
                            }
                            addMessage("<span class=\"peerMsg\">" + data[1]["playerName"] + ": </span>" +
                                data[1]["msg"]);
                            break;
                    };
                });
                currentConn.on('close', function () { // Execute code when user disconnects.
                    for (let step = 0; step < conn.length; step++) {
                        if (conn[step]["_open"] == false) {
                            delete players[conn[step]['peer']];
                            conn.splice(step, 1);
                        }
                    }
                    updatePlayerList();
                });
            }


            function setPlayerData(playerID, newName, inPlay) {
                players[playerID]["inPlay"] = inPlay;
                players[playerID]["playerName"] = newName;
                players[playerID]["role"] = "NA";
                return;
            }

            function changePlayerName(playerID, newName) {
                players[playerID]["playerName"] = newName;
                return;
            };

            function fade() {
                standbyBox.className = "display-box hidden";
                goBox.className = "display-box hidden";
                fadeBox.className = "display-box fade";
                offBox.className = "display-box hidden";
                return;
            };

            function off() {
                standbyBox.className = "display-box hidden";
                goBox.className = "display-box hidden";
                fadeBox.className = "display-box hidden";
                offBox.className = "display-box off";
                return;
            }

            function reset() {
                standbyBox.className = "display-box standby";
                goBox.className = "display-box hidden";
                fadeBox.className = "display-box hidden";
                offBox.className = "display-box hidden";
                return;
            };

            function addMessage(msg) {
                var now = new Date();
                var h = now.getHours();
                var m = addZero(now.getMinutes());

                if (h > 12)
                    h -= 12;
                else if (h === 0)
                    h = 12;

                function addZero(t) {
                    if (t < 10)
                        t = "0" + t;
                    return t;
                };

                message.innerHTML = message.innerHTML + "<br><span class=\"msg-time\">" + h + ":" + m + ":" + "</span>  -  " + msg;
            }

            function clearMessages() {
                message.innerHTML = "";
                addMessage("Msgs cleared");
            }

            // Listen for enter in message box
            sendMessageBox.addEventListener('keypress', function (e) {
                var event = e || window.event;
                var char = event.which || event.keyCode;
                if (char == '13')
                    sendButton.click();
            });
            // Send message
            sendButton.addEventListener('click', function () {
                if (conn[0] && conn[0].open) {
                    var msg = sendMessageBox.value;
                    sendMessageBox.value = "";
                    for (let step = 0; step < conn.length; step++) {
                        conn[step].send(["chatMessage", {
                            "playerName": clientPlayerName,
                            "msg": msg
                        }]);
                    }
                    console.log("Sent: " + msg)
                    addMessage("<span class=\"selfMsg\">" + clientPlayerName + ": </span>" + msg);
                } else {
                    console.log('Connection is closed');
                }
            });

            // Clear messages box
            clearMsgsButton.addEventListener('click', clearMessages);

            function updatePlayerList() {
                console.log("Player List Updating");
                playersConnectedList = "";

                for (var player in players) {
                    if (playersConnectedList == "") {
                        playersConnectedList = playersConnectedList + players[player]["playerName"];
                    } else {
                        playersConnectedList = playersConnectedList + ", " + players[player]["playerName"];
                    }
                }

                playerListElement.innerHTML = playersConnectedList;
            }

            initialize();
        })();

        // My functions
        function copyShareLink() {
            // Get the link
            var copyText = document.getElementById("share-link");

            // Copy the text in the share link element
            navigator.clipboard.writeText(copyText.innerText);
        }
    </script>

    <script src="./mimicGameLogic.js?v=0.27">
    </script>

    <script>
        console.log("length of players: " + Object.keys(players).length);
    </script>
    <style type="text/css" id="dark-mode-custom-color">
        :root {
            --bg-color: rgba(26, 26, 26, 1);
            --text-color: rgba(255, 200, 0, 1);
            --a-color: rgba(76, 200, 200, 1);
            --a-visited-color: rgba(225, 115, 25, 1);
            --a-hover-color: rgba(211, 211, 211, 1);
            --input-border-color: rgba(211, 211, 211, 0.2);
            --input-placeholder-color: rgba(111, 174, 195, 1);
            --dialog-bg-color: rgba(36, 36, 36, 0.95);
            --bg-image: linear-gradient(rgba(26, 26, 26, 1), rgba(26, 26, 26, 1));
        }
    </style>
</body>

</html>